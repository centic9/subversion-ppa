Description: fix denial of service via request containing lock token
Origin: upstream, http://svn.apache.org/viewvc?view=revision&revision=1071239
Origin: upstream, http://svn.apache.org/viewvc?view=revision&revision=1071307

diff -Nur subversion-1.6.6dfsg/subversion/mod_dav_svn/repos.c subversion-1.6.6dfsg.new/subversion/mod_dav_svn/repos.c
--- subversion-1.6.6dfsg/subversion/mod_dav_svn/repos.c	2011-03-21 15:10:34.590496426 -0400
+++ subversion-1.6.6dfsg.new/subversion/mod_dav_svn/repos.c	2011-03-21 15:10:50.190496422 -0400
@@ -1923,8 +1923,10 @@
       dav_locktoken_list *list = ltl;
 
       serr = svn_fs_get_access(&access_ctx, repos->fs);
-      if (serr)
+      if (serr || !access_ctx)
         {
+          if (serr == NULL)
+            serr = svn_error_create(SVN_ERR_FS_LOCK_OWNER_MISMATCH, NULL, NULL);
           return dav_svn__sanitize_error(serr, "Lock token is in request, "
                                          "but no user name",
                                          HTTP_BAD_REQUEST, r);
diff -Nur subversion-1.6.6dfsg/subversion/mod_dav_svn/version.c subversion-1.6.6dfsg.new/subversion/mod_dav_svn/version.c
--- subversion-1.6.6dfsg/subversion/mod_dav_svn/version.c	2008-11-02 22:15:17.000000000 -0500
+++ subversion-1.6.6dfsg.new/subversion/mod_dav_svn/version.c	2011-03-21 15:10:50.200496422 -0400
@@ -1172,11 +1172,13 @@
   svn_error_t *serr;
 
   serr = svn_fs_get_access(&fsaccess, resource->info->repos->fs);
-  if (serr)
+  if (serr || !fsaccess)
     {
       /* If an authenticated user name was attached to the request,
          then dav_svn_get_resource() should have already noticed and
          created an fs_access_t in the filesystem.  */
+      if (serr == NULL)
+        serr = svn_error_create(SVN_ERR_FS_LOCK_OWNER_MISMATCH, NULL, NULL);
       return dav_svn__sanitize_error(serr, "Lock token(s) in request, but "
                                      "missing an user name", HTTP_BAD_REQUEST,
                                      resource->info->r);
