#! /bin/sh /usr/share/dpatch/dpatch-run
## apr-abi.dpatch by <peter@p12n.org>
##
## DP: Use libtool -version-info to express library SONAMEs, and make it
## DP: sensitive to libapr ABI w/r/t 64-bit file offsets.
## DP: 
## DP: Patch has been submitted upstream.

@DPATCH@
Index: subversion-1.7.0/Makefile.in
===================================================================
--- subversion-1.7.0.orig/Makefile.in	2011-10-20 21:55:51.000000000 +0200
+++ subversion-1.7.0/Makefile.in	2011-10-20 21:55:54.000000000 +0200
@@ -205,8 +205,8 @@
 
 LINK = $(LIBTOOL) $(LTFLAGS) --mode=link $(CC) $(LT_LDFLAGS) $(CFLAGS) $(LDFLAGS)
 LINK_LIB = $(LINK) $(LT_SO_VERSION)
-LINK_CXX = $(LIBTOOL) $(LTCXXFLAGS) --mode=link $(CXX) $(LT_LDFLAGS) $(CXXFLAGS) $(LDFLAGS) -rpath $(libdir)
-LINK_LIB = $(LINK) -rpath $(libdir)
+LINK_CXX = $(LIBTOOL) $(LTCXXFLAGS) --mode=link $(CXX) $(LT_LDFLAGS) $(CXXFLAGS) $(LDFLAGS) -rpath $(libdir) $(LT_SOVERSION)
+LINK_LIB = $(LINK) -rpath $(libdir) $(LT_SO_VERSION)
 LINK_CXX_LIB = $(LINK_CXX) $(LT_SO_VERSION)
 
 # special link rule for mod_dav_svn
Index: subversion-1.7.0/build/ac-macros/apr.m4
===================================================================
--- subversion-1.7.0.orig/build/ac-macros/apr.m4	2011-10-20 20:45:56.000000000 +0200
+++ subversion-1.7.0/build/ac-macros/apr.m4	2011-10-20 21:55:54.000000000 +0200
@@ -111,11 +111,31 @@
     AC_MSG_ERROR([apr-config --shlib-path-var failed])
   fi
 
+  dnl Determine whether or not we will be using the 64-bit apr_off_t ABI.
+  dnl This necessarily changes the SONAME of libsvn_*.
+if test `expr $apr_version : 0` -ne 0; then
+  SVN_LT_SOVERSION="-version-info 0"
+else
+  SVN_LT_SOVERSION="-version-info 1"
+fi
+  dnl   oldcppflags=$CPPFLAGS
+  dnl   CPPFLAGS="$CPPFLAGS $SVN_APR_INCLUDES"
+  dnl   AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[
+  dnl #include <apr.h>
+  dnl #if APR_HAS_LARGE_FILES
+  dnl # error Large file ABI required
+  dnl #endif
+  dnl     ]])], [apr_lfs_abi=0], [apr_lfs_abi=1])
+  dnl   CPPFLAGS=$oldcppflags
+  dnl
+  dnl SVN_LT_SOVERSION="-version-info $apr_lfs_abi"
+
   AC_SUBST(SVN_APR_PREFIX)
   AC_SUBST(SVN_APR_CONFIG, ["$apr_config"])
   AC_SUBST(SVN_APR_INCLUDES)
   AC_SUBST(SVN_APR_LIBS)
   AC_SUBST(SVN_APR_SHLIB_PATH_VAR)
+  AC_SUBST(SVN_LT_SOVERSION)
 ])
 
 dnl SVN_DOWNLOAD_APR()
Index: subversion-1.7.0/subversion/libsvn_fs/fs-loader.c
===================================================================
--- subversion-1.7.0.orig/subversion/libsvn_fs/fs-loader.c	2011-10-20 20:47:31.000000000 +0200
+++ subversion-1.7.0/subversion/libsvn_fs/fs-loader.c	2011-10-20 21:55:54.000000000 +0200
@@ -100,7 +100,7 @@
     const char *funcname;
     apr_status_t status;
 
-    libname = apr_psprintf(pool, "libsvn_fs_%s-%d.so.0",
+    libname = apr_psprintf(pool, "libsvn_fs_%s-%d.so.1",
                            name, SVN_VER_MAJOR);
     funcname = apr_psprintf(pool, "svn_fs_%s__init", name);
 
Index: subversion-1.7.0/subversion/libsvn_ra/ra_loader.c
===================================================================
--- subversion-1.7.0.orig/subversion/libsvn_ra/ra_loader.c	2011-10-20 20:47:31.000000000 +0200
+++ subversion-1.7.0/subversion/libsvn_ra/ra_loader.c	2011-10-20 21:55:54.000000000 +0200
@@ -159,7 +159,7 @@
     const char *compat_funcname;
     apr_status_t status;
 
-    libname = apr_psprintf(pool, "libsvn_ra_%s-%d.so.0",
+    libname = apr_psprintf(pool, "libsvn_ra_%s-%d.so.1",
                            ra_name, SVN_VER_MAJOR);
     funcname = apr_psprintf(pool, "svn_ra_%s__init", ra_name);
     compat_funcname = apr_psprintf(pool, "svn_ra_%s_init", ra_name);
Index: subversion-1.7.0/subversion/libsvn_subr/auth.c
===================================================================
--- subversion-1.7.0.orig/subversion/libsvn_subr/auth.c	2011-10-20 20:47:32.000000000 +0200
+++ subversion-1.7.0/subversion/libsvn_subr/auth.c	2011-10-20 21:55:54.000000000 +0200
@@ -399,7 +399,7 @@
       const char *library_label, *library_name;
       const char *provider_function_name, *version_function_name;
       library_name = apr_psprintf(pool,
-                                  "libsvn_auth_%s-%d.so.0",
+                                  "libsvn_auth_%s-%d.so.1",
                                   provider_name,
                                   SVN_VER_MAJOR);
       library_label = apr_psprintf(pool, "svn_%s", provider_name);
